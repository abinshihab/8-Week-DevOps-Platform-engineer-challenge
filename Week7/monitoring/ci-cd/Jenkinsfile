pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'üåç Select the deployment environment'
        )
        booleanParam(name: 'APPLY_INFRA',   defaultValue: false, description: '‚ö° Apply Terraform changes automatically')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy monitoring stack for selected environment')
        booleanParam(name: 'ROLLBACK_ON_FAILURE', defaultValue: true, description: 'üîÅ Rollback if Terraform apply fails')
    }

    environment {
        ENV                 = "${params.TARGET_ENV}"
        TF_DIR              = "${WORKSPACE}/Week7/monitoring"
        TF_BACKEND          = "backend-${ENV}.conf"
        TF_VAR_FILE         = "envs/${ENV}/${ENV}.tfvars"
        AWS_REGION          = "us-east-1"
        TF_PLUGIN_CACHE_DIR = "${env.JENKINS_HOME}/.terraform.d/plugin-cache"
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('üì¶ Checkout Code') {
            steps {
                echo "üîÑ Checking out source code..."
                checkout scm
            }
        }

        stage('üß™ Debug Workspace (Full Tree)') {
            steps {
                echo "üîç Checking full workspace structure..."
                sh """
                echo 'üìÅ Current working directory:' && pwd
                echo 'üå≤ FULL WORKSPACE TREE:' 
                ls -R .

                echo 'üìÑ Searching for tfvars in full workspace:'
                find . -type f -name '*.tfvars' || true

                echo 'üìÇ Contents of Week7/monitoring:' 
                ls -R Week7/monitoring || true
                """
            }
        }

        stage('üß∞ Prepare Terraform Plugin Cache') {
            steps {
                echo "üì¶ Preparing Terraform plugin cache..."
                sh """
                mkdir -p "${TF_PLUGIN_CACHE_DIR}"
                chmod -R 777 "${TF_PLUGIN_CACHE_DIR}"
                echo 'Plugin cache ready: ${TF_PLUGIN_CACHE_DIR}'
                """
            }
        }

        stage('‚¨ÜÔ∏è Upgrade Providers') {
            steps {
                echo "‚¨ÜÔ∏è Upgrading Terraform AWS provider for ${ENV}..."
                sh """
                export TF_PLUGIN_CACHE_DIR="${TF_PLUGIN_CACHE_DIR}"
                terraform -chdir="${TF_DIR}" init -upgrade || true
                """
            }
        }

        stage('üöÄ Terraform Init') {
            steps {
                echo "üöÄ Initializing Terraform backend for environment: ${ENV}"
                sh """
                export TF_PLUGIN_CACHE_DIR="${TF_PLUGIN_CACHE_DIR}"
                terraform -chdir="${TF_DIR}" init \
                    -reconfigure -input=false \
                    -backend-config=${TF_BACKEND}
                """
            }
        }

        stage('üîé Terraform Validate') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                echo "üîé Validating Terraform configuration..."
                sh "terraform -chdir='${TF_DIR}' validate"
            }
        }

        stage('üìã Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                echo "üìù Generating Terraform plan for: ${ENV}"
                sh """
                terraform -chdir="${TF_DIR}" plan \
                    -input=false \
                    -var-file=${TF_VAR_FILE} \
                    -out=tfplan

                terraform -chdir="${TF_DIR}" show -no-color tfplan \
                    > ${TF_DIR}/tfplan.txt
                """
                archiveArtifacts artifacts: "Week7/monitoring/tfplan.txt", fingerprint: true
            }
        }

        stage('üõë PROD Manual Approval') {
            when { allOf { expression { ENV == 'prod' }; expression { params.APPLY_INFRA } } }
            steps {
                input message: "‚ö†Ô∏è Approve deployment to *PROD Monitoring* environment?"
            }
        }

        stage('‚ö° Terraform Apply') {
            when {
                allOf {
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                echo "‚ö° Applying Terraform for ${ENV}..."
                script {
                    def status = sh(
                        script: "terraform -chdir='${TF_DIR}' apply -input=false tfplan",
                        returnStatus: true
                    )

                    if (status != 0) {
                        echo "‚ùå Terraform apply failed for ${ENV}"
                        if (params.ROLLBACK_ON_FAILURE) {
                            echo "üîÅ Rolling back ${ENV} monitoring stack..."
                            sh "terraform -chdir='${TF_DIR}' destroy -auto-approve -var-file='${TF_VAR_FILE}'"
                        }
                        error("‚ùå Terraform apply failed with exit code ${status}")
                    }
                }
            }
        }

        stage('üí£ Terraform Destroy') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                input message: "üí£ Confirm destroy of *${ENV}* monitoring environment?"
                echo "üî• Destroying monitoring stack for ${ENV}..."
                sh "terraform -chdir='${TF_DIR}' destroy -auto-approve -var-file='${TF_VAR_FILE}'"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Monitoring pipeline completed successfully for ${ENV}"
        }
        failure {
            echo "‚ùå Monitoring pipeline FAILED for ${ENV}"
        }
        always {
            echo "üì¶ Saving plan and cleaning workspace..."
            archiveArtifacts artifacts: "Week7/monitoring/tfplan.txt", allowEmptyArchive: true
            cleanWs(deleteDirs: true)
        }
    }
}
