pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'üåç Select the deployment environment'
        )
        booleanParam(name: 'APPLY_INFRA', defaultValue: false, description: '‚ö° Apply Terraform changes automatically')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy monitoring stack')
        booleanParam(name: 'ROLLBACK_ON_FAILURE', defaultValue: true, description: 'üîÅ Rollback on failure')
    }

    environment {
        ENV                 = "${params.TARGET_ENV}"

        // üî• Correct Terraform directory
        TF_DIR              = "${WORKSPACE}/Week7/monitoring"

        // üî• Correct backend file path INSIDE Week7/monitoring/envs
        TF_BACKEND          = "envs/${ENV}/backend-${ENV}.hcl"

        // üî• Correct tfvars path INSIDE Week7/monitoring/envs
        TF_VAR_FILE         = "envs/${ENV}/${ENV}.tfvars"

        AWS_REGION          = "us-east-1"

        // üî• Correct plugin cache path for macOS Jenkins
        TF_PLUGIN_CACHE_DIR = "/Users/administrator/.jenkins/.terraform.d/plugin-cache"
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('üì¶ Checkout Code') {
            steps {
                echo "üîÑ Checking out source code..."
                checkout scm
            }
        }

        stage('üß™ Debug Workspace (Full Tree)') {
            steps {
                echo "üîç Showing workspace structure..."
                sh """
                echo 'üìÅ Current directory:' && pwd
                echo 'üå≤ WORKSPACE TREE:' 
                ls -R .

                echo 'üîé Checking Week7/monitoring:' 
                ls -R Week7/monitoring || true
                """
            }
        }

        stage('üß∞ Prepare Terraform Plugin Cache') {
            steps {
                echo "üì¶ Preparing Terraform plugin cache..."
                sh """
                mkdir -p "${TF_PLUGIN_CACHE_DIR}"
                chmod -R 777 "${TF_PLUGIN_CACHE_DIR}"
                echo 'Plugin cache ready at ${TF_PLUGIN_CACHE_DIR}'
                """
            }
        }

        stage('‚¨ÜÔ∏è Upgrade Providers') {
            steps {
                echo "‚¨ÜÔ∏è Upgrading providers..."
                sh """
                export TF_PLUGIN_CACHE_DIR="${TF_PLUGIN_CACHE_DIR}"
                terraform -chdir="${TF_DIR}" init -upgrade || true
                """
            }
        }

        stage('üöÄ Terraform Init') {
            steps {
                echo "üöÄ Initializing Terraform backend for environment: ${ENV}"
                sh """
                export TF_PLUGIN_CACHE_DIR="${TF_PLUGIN_CACHE_DIR}"

                terraform -chdir="${TF_DIR}" init \
                    -reconfigure -input=false \
                    -backend-config="${TF_BACKEND}"
                """
            }
        }

        stage('üîé Terraform Validate') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                echo "üîé Validating Terraform code..."
                sh "terraform -chdir='${TF_DIR}' validate"
            }
        }

        stage('üìã Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                echo "üìù Generating Terraform plan..."
                sh """
                terraform -chdir="${TF_DIR}" plan \
                    -input=false \
                    -var-file="${TF_VAR_FILE}" \
                    -out=tfplan

                terraform -chdir="${TF_DIR}" show -no-color tfplan > ${TF_DIR}/tfplan.txt
                """
                archiveArtifacts artifacts: "Week7/monitoring/tfplan.txt", fingerprint: true
            }
        }

        stage('üõë PROD Manual Approval') {
            when {
                allOf {
                    expression { ENV == 'prod' }
                    expression { params.APPLY_INFRA }
                }
            }
            steps {
                input message: "‚ö†Ô∏è Approve deployment to *PROD Monitoring*?"
            }
        }

        stage('‚ö° Terraform Apply') {
            when {
                allOf {
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                echo "‚ö° Applying Terraform for ${ENV}..."
                script {
                    def status = sh(
                        script: "terraform -chdir='${TF_DIR}' apply -input=false tfplan",
                        returnStatus: true
                    )

                    if (status != 0) {
                        echo "‚ùå Terraform apply FAILED"

                        if (params.ROLLBACK_ON_FAILURE) {
                            echo "üîÅ Rolling back..."
                            sh "terraform -chdir='${TF_DIR}' destroy -auto-approve -var-file='${TF_VAR_FILE}'"
                        }

                        error("‚ùå Apply failed")
                    }
                }
            }
        }

        stage('üí£ Terraform Destroy') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                input message: "üí£ Confirm destroy of *${ENV}* environment?"
                echo "üî• Destroying monitoring stack for ${ENV}..."
                sh "terraform -chdir='${TF_DIR}' destroy -auto-approve -var-file='${TF_VAR_FILE}'"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Monitoring pipeline completed successfully for ${ENV}"
        }
        failure {
            echo "‚ùå Monitoring pipeline FAILED for ${ENV}"
        }
        always {
            echo "üì¶ Saving files and cleaning workspace..."
            archiveArtifacts artifacts: "Week7/monitoring/tfplan.txt", allowEmptyArchive: true
            cleanWs(deleteDirs: true)
        }
    }
}
