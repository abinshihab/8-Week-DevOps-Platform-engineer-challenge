pipeline {
    agent any

    parameters {
        choice(name: 'TARGET_ENV', choices: ['dev', 'stage', 'prod'], description: 'Select the deployment environment')
        booleanParam(name: 'APPLY_INFRA',   defaultValue: false, description: '‚úÖ Apply Terraform changes automatically')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy monitoring stack for selected environment')
        booleanParam(name: 'ROLLBACK_ON_FAILURE', defaultValue: true, description: 'üîÅ Rollback monitoring stack if apply fails')
    }

    environment {
        ENV         = "${params.TARGET_ENV}"
        TF_DIR      = "${WORKSPACE}/Week7/monitoring"
        // ‚úÖ RELATIVE PATH FIX ‚Äî now points correctly inside TF_DIR
        TF_VAR_FILE = "envs/${ENV}/${ENV}.tfvars"
        AWS_REGION  = "us-east-1"
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('Checkout SCM') {
            steps {
                echo "üîÑ Checking out source code..."
                checkout scm
            }
        }

        stage('Parallel Checks') {
            when { expression { !params.DESTROY_INFRA } }
            parallel {
                stage('Terraform Fmt') {
                    steps {
                        dir("${TF_DIR}") {
                            sh "terraform fmt -check -recursive || true"
                        }
                    }
                }
                stage('Security Scan (tfsec)') {
                    steps {
                        dir("${TF_DIR}") {
                            sh "tfsec . || true"
                        }
                    }
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    echo "üöÄ Initializing Terraform backend for ${ENV}"
                    sh """
echo "Working dir: \$(pwd)"
terraform init -reconfigure -input=false \
  -backend-config=envs/${ENV}/backend.conf \
  -backend-config=key=terraform-monitoring/${ENV}/terraform.tfstate \
  -var-file="${TF_VAR_FILE}"
"""
                }
            }
        }

        stage('Terraform Validate') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    sh "terraform validate"
                }
            }
        }

        stage('Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üìã Creating Terraform plan for monitoring stack in ${ENV}..."
                    sh """
echo "DEBUG: pwd=\$(pwd)"
echo "DEBUG: TF_VAR_FILE=${TF_VAR_FILE}"
terraform plan -input=false -var-file="${TF_VAR_FILE}" -out=tfplan
terraform show -no-color tfplan > tfplan.txt
"""
                    archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
                }
            }
        }

        // (keep the rest of your stages ‚Äî Apply, Destroy, Promotions, etc.)
    }

    post {
        success {
            echo "‚úÖ Monitoring pipeline completed successfully for ${ENV}"
            script { notifySlack("‚úÖ Terraform Monitoring Apply succeeded for *${ENV}*") }
        }
        failure {
            echo "‚ùå Monitoring pipeline failed for ${ENV}"
            script { notifySlack("‚ùå Terraform Monitoring Pipeline failed for *${ENV}*") }
        }
        always {
            echo "üì¶ Archiving plan and cleaning workspace..."
            archiveArtifacts artifacts: "${TF_DIR}/tfplan.txt", fingerprint: true, allowEmptyArchive: true
            cleanWs(deleteDirs: true)
        }
    }
}

/** Slack Notification Helper */
def notifySlack(String message) {
    try {
        withCredentials([string(credentialsId: 'slack_webhook_url', variable: 'SLACK_WEBHOOK_URL')]) {
            sh """
curl -X POST -H 'Content-type: application/json' \
--data '{"text": "${message} - Job: ${env.JOB_NAME} #${env.BUILD_NUMBER}"}' \
"\${SLACK_WEBHOOK_URL}"
"""
        }
    } catch (err) {
        echo "‚ÑπÔ∏è Slack webhook not configured; skipping notification."
    }
}
