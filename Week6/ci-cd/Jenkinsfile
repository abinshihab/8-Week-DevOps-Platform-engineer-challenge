pipeline {
    agent any

    environment {
        TF_ENV = 'dev'                                      // Change this to dev/stage/prod as needed
        TF_VARS_FILE = "envs/${TF_ENV}/${TF_ENV}.tfvars"   // Points to your environment tfvars file
    }

    stages {

        stage('Checkout SCM') {
            steps {
                echo "ğŸ”„ Checking out code..."
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                echo "ğŸš€ Initializing Terraform..."
                sh "terraform init -reconfigure -input=false -var-file=${TF_VARS_FILE}"
            }
        }

        stage('Terraform Validate') {
            steps {
                echo "ğŸ” Validating Terraform configuration..."
                sh "terraform validate"
            }
        }

        stage('Terraform Plan') {
            steps {
                echo "ğŸ“‹ Running Terraform Plan..."
                sh "terraform plan -input=false -var-file=${TF_VARS_FILE} -out=tfplan"
            }
        }

        stage('Terraform Apply') {
            steps {
                echo "âš¡ Applying Terraform changes..."
                sh "terraform apply -auto-approve tfplan"
            }
        }
    }

    post {
        success {
            echo "âœ… Pipeline completed successfully!"
        }
        failure {
            echo "âŒ Pipeline failed!"
        }
    }
}
