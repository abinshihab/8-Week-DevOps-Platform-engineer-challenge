pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'üåç Select the deployment environment"
        )
        booleanParam(name: 'APPLY_INFRA', defaultValue: false, description: '‚ö° Apply Terraform changes automatically')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy infrastructure for selected environment')
        booleanParam(name: 'ROLLBACK_ON_FAILURE', defaultValue: true, description: 'üîÅ Rollback on failed apply')
    }

    environment {
        ENV         = "${params.TARGET_ENV}"
        TF_DIR      = "${WORKSPACE}/Week6"
        TF_VAR_FILE = "envs/${ENV}/${ENV}.tfvars"
        TF_BACKEND  = "envs/${ENV}/backend.conf"
        AWS_REGION  = "us-east-1"

        // Infracost config
        INFRACOST_API_KEY = credentials('infracost_api_key')
    }

    options {
        timeout(time: 90, unit: 'MINUTES')
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
    }

    stages {

        stage('üì¶ Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('üß™ Code Quality & Security Checks') {
            when { expression { !params.DESTROY_INFRA } }
            parallel {
                stage('üßπ terraform fmt') {
                    steps {
                        dir("${TF_DIR}") { sh "terraform fmt -check -recursive || true" }
                    }
                }
                stage('üîç tfsec Security Scan') {
                    steps {
                        dir("${TF_DIR}") { sh "tfsec . || true" }
                    }
                }
                stage('üß∞ tflint') {
                    steps {
                        dir("${TF_DIR}") { sh "tflint || true" }
                    }
                }
            }
        }

        stage('üöÄ Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    sh """
                    rm -rf .terraform .terraform.lock.hcl
                    terraform init -reconfigure -input=false \
                      -backend-config=${TF_BACKEND}
                    """
                }
            }
        }

        stage('üõ° Drift Detection (Pre-plan)') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    script {
                        def driftCode = sh(script: """
                          terraform plan -input=false -detailed-exitcode -var-file=${TF_VAR_FILE} >/dev/null
                        """, returnStatus: true)

                        if (driftCode == 2) {
                            echo "‚ö†Ô∏è DRIFT DETECTED in ${ENV}"
                            notifySlack("‚ö†Ô∏è Drift detected in *${ENV}* environment ‚Äî review recommended!")
                        } else {
                            echo "‚úÖ No drift detected for ${ENV}"
                        }
                    }
                }
            }
        }

        stage('üìã Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    sh """
                    terraform plan -input=false \
                      -var-file=${TF_VAR_FILE} \
                      -out=tfplan
                    terraform show -no-color tfplan > tfplan.txt
                    """
                    archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
                }
            }
        }

        stage('üí∏ Cost Estimation (Infracost)') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    sh """
                    infracost breakdown \
                      --path tfplan \
                      --format json \
                      --out-file infracost.json
                    """

                    sh """
                    infracost output \
                      --format table \
                      --path infracost.json > infracost.txt
                    """

                    archiveArtifacts artifacts: 'infracost.txt', fingerprint: true

                    script {
                        def msg = readFile("${TF_DIR}/infracost.txt")
                        notifySlack("üí∏ *Infracost Report for ${ENV}:*\n```${msg}```")
                    }
                }
            }
        }

        stage('üõë Manual Approval (Prod Only)') {
            when {
                allOf {
                    expression { params.ENV == 'prod' }
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                input message: "‚ö†Ô∏è Confirm deployment to *PROD*?"
            }
        }

        stage('‚ö° Terraform Apply') {
            when {
                allOf {
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                dir("${TF_DIR}") {
                    script {
                        def applyCode = sh(script: "terraform apply -input=false tfplan", returnStatus: true)

                        if (applyCode != 0) {
                            echo "‚ùå Failed apply for ${ENV}"
                            if (params.ROLLBACK_ON_FAILURE) {
                                sh "terraform apply -refresh-only -auto-approve -var-file=${TF_VAR_FILE}"
                                notifySlack("‚ö†Ô∏è Rollback executed for *${ENV}* due to apply failure")
                            }
                            error("Apply failed")
                        }
                    }
                }
            }
        }

        stage('üí£ Terraform Destroy') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    sh """
                    terraform destroy -auto-approve \
                      -var-file=${TF_VAR_FILE}
                    """
                }
            }
        }
    }

    post {
        success {
            notifySlack("‚úÖ Terraform Pipeline SUCCESS for *${ENV}*")
        }
        failure {
            notifySlack("‚ùå Terraform Pipeline FAILED for *${ENV}*")
        }
        always {
            cleanWs(deleteDirs: true)
        }
    }
}

/*** Slack Helper ***/
def notifySlack(String message) {
    try {
        withCredentials([string(credentialsId: 'slack_webhook_url', variable: 'SLACK_URL')]) {
            sh """
            curl -X POST -H 'Content-Type: application/json' \
            --data '{\"text\": \"${message}\"}' "\${SLACK_URL}"
            """
        }
    } catch (e) {
        echo "Slack not configured"
    }
}
