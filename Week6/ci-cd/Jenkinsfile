pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'Select the deployment environment'
        )
        booleanParam(
            name: 'APPLY_INFRA',
            defaultValue: false,
            description: '‚úÖ Apply Terraform changes automatically'
        )
        booleanParam(
            name: 'DESTROY_INFRA',
            defaultValue: false,
            description: 'üí£ Destroy infrastructure for selected environment (with confirmation prompt)'
        )
        booleanParam(
            name: 'ROLLBACK_ON_FAILURE',
            defaultValue: true,
            description: 'üîÅ Rollback infrastructure if apply fails'
        )
    }

    environment {
        ENV = "${params.TARGET_ENV}"
        TF_DIR = "${WORKSPACE}/Week6"
        TF_VAR_FILE = "envs/${ENV}/${ENV}.tfvars"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }

        stage('Parallel Checks') {
            when { expression { return !params.DESTROY_INFRA } }
            parallel {
                stage('Terraform Lint') {
                    steps {
                        dir("${TF_DIR}") {
                            echo "üßπ Running Terraform fmt check..."
                            sh "terraform fmt -check -recursive || true"
                        }
                    }
                }

                stage('Security Scan (tfsec)') {
                    steps {
                        dir("${TF_DIR}") {
                            echo "üõ°Ô∏è Running tfsec security scan..."
                            sh "tfsec . || true"
                        }
                    }
                }
            }
        }

        // ‚úÖ Updated Terraform Init Stage with backend.conf support
        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    echo "üöÄ Initializing Terraform for environment: ${ENV}"
                    sh """
                    terraform init -reconfigure -input=false \
                      -backend-config=envs/${ENV}/backend.conf \
                      -var-file=${TF_VAR_FILE}
                    """
                }
            }
        }

        stage('Terraform Validate') {
            when { expression { return !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üîé Validating Terraform configuration..."
                    sh "terraform validate"
                }
            }
        }

        stage('Terraform Plan') {
            when { expression { return !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üìã Running Terraform Plan for ${ENV}..."
                    withCredentials([
                        string(credentialsId: 'my_trusted_ip', variable: 'MY_TRUSTED_IP'),
                        string(credentialsId: 'allowed_ssh_cidr', variable: 'ALLOWED_SSH_CIDR')
                    ]) {
                        sh """
                        terraform plan -input=false \
                          -var-file=${TF_VAR_FILE} \
                          -var="my_trusted_ip=\${MY_TRUSTED_IP}" \
                          -var="allowed_ssh_cidr=\${ALLOWED_SSH_CIDR}" \
                          -out=tfplan
                        terraform show -no-color tfplan > tfplan.txt
                        """
                    }
                    archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
                }
            }
        }

        stage('Manual Approval (for prod)') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'prod' }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                input message: "‚ö†Ô∏è Approve deployment to *PROD* environment?", ok: "Deploy"
            }
        }

        stage('Terraform Apply') {
            when {
                allOf {
                    expression { return params.APPLY_INFRA == true }
                    expression { return !params.DESTROY_INFRA }
                }
            }
            steps {
                dir("${TF_DIR}") {
                    echo "‚ö° Applying Terraform for ${ENV}..."
                    withCredentials([
                        string(credentialsId: 'my_trusted_ip', variable: 'MY_TRUSTED_IP'),
                        string(credentialsId: 'allowed_ssh_cidr', variable: 'ALLOWED_SSH_CIDR')
                    ]) {
                        script {
                            def applyStatus = sh(script: "terraform apply -input=false tfplan", returnStatus: true)
                            if (applyStatus != 0) {
                                echo "‚ùå Apply failed for ${ENV}"
                                if (params.ROLLBACK_ON_FAILURE) {
                                    echo "üîÅ Rolling back ${ENV} infrastructure..."
                                    sh "terraform destroy -auto-approve -var-file=${TF_VAR_FILE}"
                                }
                                error("Terraform apply failed with status ${applyStatus}")
                            }
                        }
                    }
                }
            }
        }

        stage('Terraform Destroy') {
            when { expression { return params.DESTROY_INFRA == true } }
            steps {
                dir("${TF_DIR}") {
                    input message: "üí£ Confirm destroy of *${ENV}* environment?", ok: "Yes, destroy it!"
                    echo "üî• Destroying Terraform-managed resources for ${ENV}..."
                    withCredentials([
                        string(credentialsId: 'my_trusted_ip', variable: 'MY_TRUSTED_IP'),
                        string(credentialsId: 'allowed_ssh_cidr', variable: 'ALLOWED_SSH_CIDR')
                    ]) {
                        sh """
                        terraform destroy -auto-approve \
                          -var-file=${TF_VAR_FILE} \
                          -var="my_trusted_ip=\${MY_TRUSTED_IP}" \
                          -var="allowed_ssh_cidr=\${ALLOWED_SSH_CIDR}"
                        """
                    }
                }
            }
        }

        // üÜï Auto-Promotion from DEV ‚Üí STAGE
        stage('Promote to Stage') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'dev' }
                    expression { currentBuild.currentResult == 'SUCCESS' }
                }
            }
            steps {
                echo "üöÄ Dev deployment successful ‚Äî promoting to Stage..."
                build job: env.JOB_NAME,
                    parameters: [
                        string(name: 'TARGET_ENV', value: 'stage'),
                        booleanParam(name: 'APPLY_INFRA', value: true)
                    ],
                    wait: false
            }
        }

        // üÜï Manual Promotion from STAGE ‚Üí PROD
        stage('Promote to Prod') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'stage' }
                    expression { currentBuild.currentResult == 'SUCCESS' }
                }
            }
            steps {
                input message: "üö¶ Approve promotion to *PROD*?", ok: "Proceed"
                build job: env.JOB_NAME,
                    parameters: [
                        string(name: 'TARGET_ENV', value: 'prod'),
                        booleanParam(name: 'APPLY_INFRA', value: true)
                    ],
                    wait: false
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline finished successfully for ${ENV}!"
            script {
                try {
                    withCredentials([string(credentialsId: 'slack_webhook_url', variable: 'SLACK_WEBHOOK_URL')]) {
                        def msg = params.DESTROY_INFRA ?
                            "üí£ Terraform Destroy completed for *${ENV}*" :
                            "‚úÖ Terraform Apply succeeded for *${ENV}*"
                        sh """
                        curl -X POST -H 'Content-type: application/json' \
                        --data '{"text": "${msg} - Job: \${env.JOB_NAME} #\${env.BUILD_NUMBER}"}' \
                        "\${SLACK_WEBHOOK_URL}"
                        """
                    }
                } catch (e) {
                    echo "‚ÑπÔ∏è Slack credential not found, skipping notification."
                }
            }
        }

        failure {
            echo "‚ùå Pipeline failed for ${ENV}!"
            script {
                try {
                    withCredentials([string(credentialsId: 'slack_webhook_url', variable: 'SLACK_WEBHOOK_URL')]) {
                        sh """
                        curl -X POST -H 'Content-type: application/json' \
                        --data '{"text": "‚ùå Terraform Pipeline failed for *${ENV}* - Job: \${env.JOB_NAME} #\${env.BUILD_NUMBER}"}' \
                        "\${SLACK_WEBHOOK_URL}"
                        """
                    }
                } catch (e) {
                    echo "‚ÑπÔ∏è Slack credential not found, skipping notification."
                }
            }
        }

        always {
            echo "üîî Pipeline finished (Environment: ${ENV})"
        }
    }
}
