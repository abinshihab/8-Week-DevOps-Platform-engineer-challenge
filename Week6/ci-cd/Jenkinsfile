pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'Select the deployment environment'
        )
        booleanParam(name: 'APPLY_INFRA', defaultValue: false, description: '‚ö° Apply Terraform changes automatically')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy infrastructure for selected environment')
        booleanParam(name: 'ROLLBACK_ON_FAILURE', defaultValue: true, description: 'üîÅ Rollback if apply fails')
    }

    environment {
        ENV         = "${params.TARGET_ENV}"
        TF_DIR      = "${WORKSPACE}/Week6"
        TF_VAR_FILE = "envs/${ENV}/${ENV}.tfvars"
        AWS_REGION  = "us-east-1"
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('Checkout SCM') {
            steps {
                echo "üîÑ Checking out source code..."
                checkout scm
            }
        }

        stage('Parallel Checks') {
            when { expression { !params.DESTROY_INFRA } }
            parallel {
                stage('Terraform Fmt') {
                    steps {
                        dir("${TF_DIR}") {
                            sh "terraform fmt -check -recursive || true"
                        }
                    }
                }
                stage('Security Scan (tfsec)') {
                    steps {
                        dir("${TF_DIR}") {
                            sh "tfsec . || true"
                        }
                    }
                }
                stage('Lint (tflint)') {
                    steps {
                        dir("${TF_DIR}") {
                            sh "tflint || true"
                        }
                    }
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    echo "üöÄ Initializing Terraform for ${ENV}"
                    sh """
                    rm -rf .terraform .terraform.lock.hcl
                    terraform init -reconfigure -input=false \
                      -backend-config=envs/${ENV}/backend.conf
                    """
                }
            }
        }

        stage('Terraform Validate') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üîé Validating Terraform configuration..."
                    sh "terraform validate"
                }
            }
        }

        stage('Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üìù Generating Terraform plan..."
                    sh """
                    terraform plan -input=false \
                      -var-file=${TF_VAR_FILE} \
                      -out=tfplan

                    terraform show -no-color tfplan > tfplan.txt
                    """
                    archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
                }
            }
        }

        stage('Manual Approval (PROD only)') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'prod' }
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                input message: "‚ö†Ô∏è Approve deployment to PROD?", ok: "Deploy"
            }
        }

        stage('Terraform Apply') {
            when {
                allOf {
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                dir("${TF_DIR}") {
                    echo "‚ö° Applying Terraform for ${ENV}..."
                    script {
                        def applyStatus = sh(script: "terraform apply -input=false tfplan", returnStatus: true)

                        if (applyStatus != 0) {
                            echo "‚ùå Terraform apply failed for ${ENV}"

                            if (params.ROLLBACK_ON_FAILURE) {
                                echo "üîÅ Running refresh-only rollback..."
                                sh "terraform apply -refresh-only -auto-approve -var-file=${TF_VAR_FILE} || true"
                                notifySlack("‚ö†Ô∏è Refresh-only rollback executed for ${ENV}")
                            }

                            error("Apply failed with exit code ${applyStatus}")
                        }
                    }
                }
            }
        }

        stage('Terraform Destroy') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üí£ Destroying infrastructure for ${ENV}..."
                    sh "terraform destroy -auto-approve -var-file=${TF_VAR_FILE}"
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline completed successfully for ${ENV}"
            script { notifySlack("‚úÖ Terraform Apply succeeded for ${ENV}") }
        }
        failure {
            echo "‚ùå Pipeline failed for ${ENV}"
            script { notifySlack("‚ùå Terraform Pipeline failed for ${ENV}") }
        }
        always {
            echo "üßπ Cleaning workspace..."
            cleanWs(deleteDirs: true)
        }
    }
}

/* Slack Notification Helper */
def notifySlack(String message) {
    try {
        withCredentials([string(credentialsId: 'slack_webhook_url', variable: 'SLACK_WEBHOOK_URL')]) {
            sh """
            curl -X POST -H 'Content-type: application/json' \
            --data '{\"text\": \"${message}\"}' \
            "\${SLACK_WEBHOOK_URL}"
            """
        }
    } catch (err) {
        echo "‚ÑπÔ∏è Slack webhook not configured"
    }
}
