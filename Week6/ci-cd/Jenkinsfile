pipeline {
    agent any

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'stage', 'prod'],
            description: 'üåç Select deployment environment'
        )
        booleanParam(name: 'APPLY_INFRA', defaultValue: false, description: '‚ö° Apply Terraform changes')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'üí£ Destroy environment')
    }

    environment {
        ENV         = "${params.TARGET_ENV}"
        TF_DIR      = "${WORKSPACE}/Week6"
        TF_VAR_FILE = "envs/${ENV}/${ENV}.tfvars"
        TF_BACKEND  = "envs/${ENV}/backend.conf"
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    stages {

        stage('üì¶ Checkout Code') {
            steps {
                echo "üîÑ Pulling latest code from repository..."
                checkout scm
            }
        }

        stage('üöÄ Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    echo "üß© Initializing Terraform backend for ${ENV}..."
                    sh """
                    rm -rf .terraform .terraform.lock.hcl
                    terraform init -reconfigure -input=false \
                        -backend-config=${TF_BACKEND}
                    """
                }
            }
        }

        stage('üîé Terraform Validate') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üìò Validating Terraform configuration..."
                    sh "terraform validate"
                }
            }
        }

        stage('üìù Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üõ† Generating Terraform plan for ${ENV}..."
                    sh """
                    terraform plan -input=false \
                        -var-file=${TF_VAR_FILE} \
                        -out=tfplan

                    terraform show -no-color tfplan > tfplan.txt
                    """
                    archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
                }
            }
        }

        stage('üõë Approval (PROD Only)') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'prod' }
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                echo "‚ö†Ô∏è Waiting for PROD approval..."
                input message: "‚ö†Ô∏è Approve deployment to *PROD* environment?", ok: "üöÄ Deploy"
            }
        }

        stage('‚ö° Terraform Apply') {
            when { 
                allOf {
                    expression { params.APPLY_INFRA }
                    expression { !params.DESTROY_INFRA }
                }
            }
            steps {
                dir("${TF_DIR}") {
                    echo "‚ö° Applying Terraform changes for ${ENV}..."
                    sh "terraform apply -input=false tfplan"
                }
            }
        }

        stage('üí£ Terraform Destroy') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                dir("${TF_DIR}") {
                    echo "üî• Destroying ${ENV} environment..."
                    sh "terraform destroy -auto-approve -var-file=${TF_VAR_FILE}"
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning workspace..."
            script { cleanWs() }
        }
    }
}
